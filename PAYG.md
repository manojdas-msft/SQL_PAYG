# Arc SQL Server License Conversion Script

## Overview
This PowerShell script automates the conversion of Azure Arc-enabled SQL Server instances from their current licensing model to **Pay-As-You-Go (PAYG)** licensing. It also enables the **"Apply physical core license"** option for each instance.

## Features
- ✅ Batch processing from CSV input file
- ✅ Converts to PAYG licensing model
- ✅ Enables physical core license option
- ✅ Comprehensive error handling and reporting
- ✅ WhatIf support for safe testing
- ✅ Detailed CSV output with results
- ✅ Progress tracking and verbose logging
- ✅ Skips already-configured instances

## Prerequisites

### Required PowerShell Modules
```powershell
Install-Module -Name Az.Accounts -Force
Install-Module -Name Az.Resources -Force
Install-Module -Name Az.ConnectedMachine -Force
```

### Required Permissions
- Contributor or Owner role on the Azure subscription
- Access to the resource groups containing Arc SQL Server instances

## Parameters

| Parameter | Required | Description |
|-----------|----------|-------------|
| `CsvPath` | Yes | Path to the input CSV file containing Arc SQL Server instances |
| `OutputPath` | Yes | Directory path where the output CSV file will be saved |
| `SubscriptionId` | Yes | Azure subscription ID containing the Arc SQL Server instances |
| `WhatIf` | No | Preview changes without executing them |
| `Verbose` | No | Enable detailed logging output |

## CSV File Format

The input CSV file should contain the following columns (generated by the health check script):
- **ServerName**: Name of the Arc SQL Server instance
- **ResourceGroup**: Azure resource group name
- **MachineName**: Name of the connected machine
- **CurrentLicenseType**: Current license type (optional, for reference)

Example CSV:
```csv
ServerName,ResourceGroup,Location,MachineName,CurrentLicenseType
WSQL2022_MSSQLSERVER2017,rgInova-poc,eastus,WSQL2022,Paid
WSQL2025_MSSQLSERVER2025,rgInova-poc,eastus,WSQL2025,Paid
```

## Usage Examples

### Example 1: Test Run (WhatIf Mode)
```powershell
.\Set-ArcSql-LicenseToPAYG.ps1 `
    -CsvPath "C:\scripts\ArcSQLHealthCheck_20260110_165143.csv" `
    -OutputPath "C:\Scripts" `
    -SubscriptionId "77b80376-724a-40fa-8c15-710765be0046" `
    -WhatIf `
    -Verbose
```

### Example 2: Execute Conversion
```powershell
.\Set-ArcSql-LicenseToPAYG.ps1 `
    -CsvPath "C:\scripts\ArcSQLHealthCheck_20260110_165143.csv" `
    -OutputPath "C:\Scripts" `
    -SubscriptionId "77b80376-724a-40fa-8c15-710765be0046" `
    -Verbose
```

### Example 3: Basic Execution (Minimal Output)
```powershell
.\Set-ArcSql-LicenseToPAYG.ps1 `
    -CsvPath "C:\scripts\ArcSQLHealthCheck_20260110_165143.csv" `
    -OutputPath "C:\Scripts" `
    -SubscriptionId "77b80376-724a-40fa-8c15-710765be0046"
```

## Output

### Console Output
The script provides real-time progress updates:
- Authentication status
- Processing progress for each server
- Success/failure indicators
- Summary statistics

### CSV Output File
Generated file: `ArcSQL_LicenseConversion_YYYYMMDD_HHMMSS.csv`

Columns:
- **ServerName**: SQL Server instance name
- **ResourceGroup**: Resource group
- **MachineName**: Connected machine name
- **PreviousLicenseType**: License type before conversion
- **NewLicenseType**: License type after conversion (PAYG)
- **PhysicalCoreLicense**: Status of physical core license option
- **Status**: Success, Failed, Skipped, or WhatIf
- **ErrorMessage**: Error details (if applicable)
- **ProcessedDateTime**: Timestamp of processing

### Example Output CSV
```csv
ServerName,ResourceGroup,MachineName,PreviousLicenseType,NewLicenseType,PhysicalCoreLicense,Status,ErrorMessage,ProcessedDateTime
WSQL2022_MSSQLSERVER2017,rgInova-poc,WSQL2022,Paid,PAYG,Enabled,Success,,2026-01-10 18:30:45
WSQL2025_MSSQLSERVER2025,rgInova-poc,WSQL2025,Paid,PAYG,Enabled,Success,,2026-01-10 18:30:52
```

## Status Values

| Status | Description |
|--------|-------------|
| **Success** | License successfully converted to PAYG with physical core license enabled |
| **Failed** | Conversion failed (see ErrorMessage for details) |
| **Skipped - Already Configured** | Server already has PAYG license with physical core license enabled |
| **WhatIf - Not Executed** | Running in WhatIf mode, no changes were made |

## Error Handling

The script includes comprehensive error handling:
- ✅ Validates CSV file existence and format
- ✅ Validates output directory
- ✅ Checks Azure authentication
- ✅ Verifies subscription access
- ✅ Validates required PowerShell modules
- ✅ Continues processing remaining servers if one fails
- ✅ Captures detailed error messages in output CSV

## Best Practices

1. **Always test first**: Run with `-WhatIf` parameter before executing
2. **Review the CSV**: Ensure the input CSV contains the correct servers
3. **Check permissions**: Verify you have appropriate Azure RBAC roles
4. **Monitor output**: Use `-Verbose` for detailed logging
5. **Keep results**: Save the output CSV for audit purposes
6. **Verify changes**: Check the Azure Portal after execution

## Troubleshooting

### Common Issues

**Issue**: "Module not found"
```powershell
# Solution: Install required modules
Install-Module -Name Az.Accounts, Az.Resources, Az.ConnectedMachine -Force
```

**Issue**: "Not authenticated to Azure"
```powershell
# Solution: The script will prompt for authentication
# Or authenticate manually first:
Connect-AzAccount
```

**Issue**: "Resource not found"
- Verify the subscription ID is correct
- Ensure the resource group and server names in CSV are accurate
- Check that you have permissions to access the resources

**Issue**: "Physical core license not enabled"
- The property name may vary by API version
- Check the Azure Portal to verify the setting
- Review the ErrorMessage column in the output CSV

## Important Notes

⚠️ **License Changes**: Converting to PAYG will change your billing model. Ensure this aligns with your licensing strategy.

⚠️ **Physical Core License**: This option applies existing physical core licenses to the virtual machine, which may affect your billing.

⚠️ **Permissions Required**: You need Contributor or Owner permissions on the subscription or resource group.

⚠️ **API Variations**: The exact property name for physical core licensing may vary. The script uses `UsePhysicalCoreLicense` which is common, but verify this works in your environment.

## Support

For issues or questions:
1. Review the ErrorMessage column in the output CSV
2. Run with `-Verbose` flag for detailed logging
3. Check Azure Activity Log for API call details
4. Verify Azure Arc SQL Server API documentation for latest property names

## Version History

- **v1.1** (2026-01-10): Production-ready version
  - Enhanced export reliability with 4 fallback methods
  - Conditional debug output (only with -Verbose)
  - Improved error handling and reporting
  - Added comprehensive production guide
  - Tested and verified on live systems
- **v1.0** (2026-01-10): Initial release
  - PAYG license conversion
  - Physical core license enablement
  - CSV batch processing
  - Comprehensive error handling

## Production Deployment

For production deployments with 100+ servers, please review the **PRODUCTION_GUIDE.md** document which covers:
- Scaling considerations for 500+ servers
- Common production errors and solutions
- Batch processing strategies
- Performance optimization
- Rollback procedures
